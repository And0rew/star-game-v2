<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Звездные войны</title>
	<style>
		html, body {
			padding: 0;
			margin: 0;
		}

		.adm-control {
			position: fixed;
			width: 200px;
			right: 20px;
			top: 20px;
			padding: 20px;
		}
	</style>
</head>
<body>
	<div class="adm-control">
		<input type="text" id="objectId"/>
		<button onclick="setMyObject()">Управлять</button>
	</div>
	<canvas id = "canvas" width="1500" height="800"></canvas>
	<script src="https://code.jquery.com/jquery-2.1.0.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js" ></script>
	<script src="map.js" ></script>

	<script src="graphics.js" ></script>
	<script src="sockets.js" ></script>

	<script src="gameplay.js" ></script>
	<script>
		var canvas = document.getElementById("canvas");
		var ctx = canvas.getContext("2d");
		canvas.width = innerWidth
		canvas.height = innerHeight
		start_game(canvas, ctx)
		var keys = {
			37: "Left",
			38: "Up",
			39: "Right",
			40: "Down",
			69: "e",
			187: "Plus",
			189: "Minus"
		}
		var obModul = function (number) {
			if (number > 0) {
				return -number
			} else {
				return number
			}
		}
		var modul = function (number) {
			if (number < 0) {
				return -number
			} else {
				return number
			}
		}


		if (localStorage.myObjectId) {
			Game.myId = localStorage.myObjectId
			let input = document.getElementById("objectId")
			if (input) {
				input.value = Game.myId
			}
		}
		function setMyObject() {
			let input = document.getElementById("objectId")
			let myObjectId = input.value
   			Game.myId = myObjectId
   			localStorage.myObjectId = myObjectId
		}
		$("body").keydown(function (event) {
			if (keys[event.keyCode] === "Left") {
				Game.camera[0] = Game.camera[0] - 20
			} else if (keys[event.keyCode] === "Right") {
				Game.camera[0] = Game.camera[0] + 20
			} else if (keys[event.keyCode] === "Up") {
				Game.camera[1] = Game.camera[1] - 20
			} else if (keys[event.keyCode] === "Down") {
				Game.camera[1] = Game.camera[1] + 20
			} else if (keys[event.keyCode] === "Plus") {
				Game.bloock_r = Game.bloock_r + 0.05
			} else if (keys[event.keyCode] === "Minus") {
				Game.bloock_r = Game.bloock_r - 0.05
				if (Game.bloock_r < 0.05) {
					Game.bloock_r = 0.05
				}
			} else if (keys[event.keyCode] === "e") {
				var myPlayer = Game.state.objects[Game.myId]

				if (Game.currentMap !== myPlayer.map) {
					return
				}

				if (!myPlayer.carInId) {
					for (var key in Game.state.objects) {
						var car = Game.state.objects[key]
						if (car.type === "car") {
							if (modul(myPlayer.x - car.x) < 101) {
								if (modul(myPlayer.y - car.y) < 101) {
									if (!car.driverId) {
										game_update(["objects", car.id, "driverId"], myPlayer.id)
										game_update(["objects", myPlayer.id, "carInId"], car.id)
										game_update(["objects", myPlayer.id, "carSit"], "d")
										game_update(["objects", myPlayer.id, "vx"], 0)
										game_update(["objects", myPlayer.id, "vy"], 0)
									} else if (_.size(car.passengerIds) < car.maxPassengers) {
										game_update(["objects", car.id, "passengerIds", myPlayer.id], true)
										// car.passengerIds[myPlayer.id] = true

										game_update(["objects", myPlayer.id, "carInId"], car.id)
										game_update(["objects", myPlayer.id, "carSit"], "p")
										game_update(["objects", myPlayer.id, "vx"], 0)
										game_update(["objects", myPlayer.id, "vy"], 0)

										myPlayer.carInId = car.id
										myPlayer.carSit = "p"
									}
									/*game_update(["objects", car.id, "x"], myPlayer.x)
									game_update(["objects", car.id, "y"], myPlayer.y)
									game_update(["objects", car.id, "g"], myPlayer.g)*/
								}
							}
						}
					}
				} else {
					/*var car = Game.state.objects[myPlayer.carInId]
					game_update(["objects", myPlayer.id, "carInId"], none)
					game_update(["objects", myPlayer.id, "carSit"], none)*/
				}
			}
		});

		var n = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
		var random = function (length) {
			var id = [];
			for (var i = 0; i < length; i++) {
				var num = n[Math.floor(Math.random() * 10)];
				id[i] = n[num]
			}
			return id.join("")
		}

		var xm = 0
		var ym = 0

		var clickHandler = function (event) {
			var xm = Math.floor((event.clientX + Game.camera[0]) / Game.bloock_r)
			var ym = Math.floor((event.clientY + Game.camera[1]) / Game.bloock_r)
			if (!Game.myId) {
				return
			}
			var object = Game.state.objects[Game.myId]

			if (!object) {
				return
			}

			if (Game.currentMap !== object.map) {
				return
			}

			if (object.carInId && object.carSit === 'd') {
				object = Game.state.objects[object.carInId]
			}

			var dx = xm - object.x
			var dy = ym - object.y

			var k = Math.abs(dx / dy)

			var vy = object.v / Math.sqrt(k * k + 1)
			var vx = k * vy

			if (xm < object.x) {
				vx = -vx
			}
			if (ym < object.y) {
				vy = -vy
			}

			console.log('vx, vy', [vx, vy])

			// идея один. Запомни в игроке куда нажали
			game_update(["objects", object.id, "target"], [xm, ym])

			// идея два. Посчитай vx и vy тут и задай их как в консоле
			// тут расчёт по формулам
			game_update(["objects", object.id, "vx"], vx)
			game_update(["objects", object.id, "vy"], vy)

		};

		var save
		var clickHandlerV = function (event) {
			save = _.size(Game.state.shots)

			if (!Game.myId) {
				return
			}
			var object = Game.state.objects[Game.myId]
			if (!object) {
				return
			}

			if (Game.currentMap !== object.map) {
				return
			}

			var k = Math.tan(object.g / 180 * Math.PI)
			var V_SHOT = 0.4
			var vy = V_SHOT / Math.sqrt(k * k + 1)
			var vx = Math.abs(k * vy)

			console.log(object.g)
			if (object.g >= 0 && object.g < 90) {
				vy = -vy
			} else if (object.g <= 0 && object.g > -90) {
				vy = -vy
				vx = -vx
			} else if (object.g <= -90 && object.g > -180) {
				vx = -vx
			}
			var life = 3000
			var date_create = Date.now()
			var shotId = random(16)
			game_update(["shots", shotId], {
				id: shotId,
				x: object.x + 49 / 2,
				y: object.y + 30 / 2,
				g: object.g,
				vx: vx,
				vy: vy,
				v: V_SHOT,
				date_create: date_create,
				time_life: life,
				time_not_life: date_create + life,
				myid: Game.myId,

				map: object.map,
			})
			console.log(["Id:", shotId, "x:", Game.state.shots[shotId].x, "y:", Game.state.shots[shotId].y, "g:", Game.state.shots[shotId].g].join(" "))
		}

		var moveHandler = function (event) {
			var xm = Math.floor((event.clientX + Game.camera[0]) / Game.bloock_r)
			var ym = Math.floor((event.clientY + Game.camera[1]) / Game.bloock_r)
			if (!Game.myId) {
				return
			}
			var object = Game.state.objects[Game.myId]

			if (!object) {
				return
			}

			if (Game.currentMap !== object.map) {
				return
			}

			if (object.carInId && object.carSit === 'd') {
				object = Game.state.objects[object.carInId]
			}

			var dx = xm - object.x
			var dy = ym - object.y

			var k = dy / dx
			var g = Math.atan(k) / Math.PI * 180
			if  (dx < 0) {
				g = g - 90
			} else {
				g = g + 90
			}
			game_update(["objects", object.id, "g"], g)
		}

		$("canvas").mousemove(moveHandler);
		$("canvas").click(clickHandlerV);
		$("canvas").on("contextmenu", (e) => {
			clickHandler(e)
			return false;
		})
	</script>
</body>
</html>